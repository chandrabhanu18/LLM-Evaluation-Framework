# Multi-stage Dockerfile optimized for CI builds and small final image
FROM python:3.11-slim as builder
ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git gcc libpq-dev curl && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
# Copy only packaging metadata first for efficient caching
COPY pyproject.toml poetry.lock* /app/
# Install build-time deps and wheel
RUN python -m pip install --upgrade pip setuptools wheel
# Copy everything and build wheels
COPY . /app
RUN python -m pip wheel --no-deps -w /wheels .

FROM python:3.11-slim as runtime
ENV PYTHONUNBUFFERED=1
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && rm -rf /var/lib/apt/lists/*
# Create non-root user
RUN useradd --create-home --shell /bin/bash appuser
WORKDIR /home/appuser/app
COPY --from=builder /wheels /wheels
RUN python -m pip install --no-deps /wheels/*.whl
# Copy examples and default configs to image for smoke tests
COPY examples/ examples/
COPY benchmarks/ benchmarks/
RUN chown -R appuser:appuser /home/appuser/app
USER appuser
ENV PATH="/home/appuser/.local/bin:${PATH}"
# Default entry runs CLI; CI will override command to run smoke tests
ENTRYPOINT ["python","-m","llm_eval.cli"]
CMD ["--help"]
